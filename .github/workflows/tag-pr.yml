name: Test Tag Creation

on:
  push:
    branches: [main]

jobs:
  test-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Create test tag
        env:
          COMMIT_SHA: ${{ github.sha }}
          PR_NUMBER: 999
          PR_TITLE: "Test PR for tag creation"
        run: |
          TAG_NAME=$(echo "pr-$PR_NUMBER-$PR_TITLE" | \
            tr '[:upper:]' '[:lower:]' | \
            sed 's/[^a-z0-9.-]/-/g' | \
            sed 's/--*/-/g' | \
            sed 's/^-//;s/-$//')

          echo "Creating test tag: $TAG_NAME"

          # Create JSON payload safely
          jq -n --arg ref "refs/tags/$TAG_NAME" --arg sha "$COMMIT_SHA" \
            '{ref: $ref, sha: $sha}' > payload.json

          # Create the tag
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d @payload.json \
            "https://api.github.com/repos/${{ github.repository }}/git/refs" \
            && echo "Tag created successfully!" \
            || echo "Failed to create tag"

          # List lightweight tags
          echo "Current tags:"
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/git/refs/tags" | \
            jq -r '.[].ref'
